<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JKT48 Tierlist</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  </head>
  <body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <div class="bg-gray-800 px-4 py-3 flex items-center">
      <button onclick="history.back()" class="text-white mr-2">‚¨Ö</button>
      <img src="https://jkt48.com/images/logo.svg" alt="Logo" class="w-6 h-6" />
      <span class="text-lg font-semibold">JKT48 Tierlist</span>
    </div>

    <!-- Main Title -->
    <div class="tierContainer">
      <div class="text-center mt-6 mb-4">
        <h1 class="text-2xl font-semibold" id="pageTitle">My Tierlist</h1>
      </div>

      <!-- Tier Area -->
      <div class="w-[96%] mx-auto bg-gray-800 rounded-lg overflow-hidden">
        <div id="tierListContainer">
          <div class="tier-row flex flex-col sm:flex-row min-h-32">
            <!-- Tier label & menu -->
            <div class="flex items-center justify-between w-40 px-4 py-2 bg-[#ff7f7e] relative">
              <span class="font-bold text-black text-xl">S Tier</span>
              <button class="settings-btn relative text-black">‚öô</button>
            </div>
            <!-- Drop area untuk item -->
            <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
            </div>
          </div>

          <div class="tier-row flex flex-col sm:flex-row min-h-32">
            <!-- Tier label & menu -->
            <div class="flex items-center justify-between w-40 px-4 py-2 bg-[#ffbf7f] relative">
              <span class="font-bold text-black text-xl">A Tier</span>
              <button class="settings-btn relative text-black">‚öô</button>
            </div>
            <!-- Drop area untuk item -->
            <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
            </div>
          </div>

          <div class="tier-row flex flex-col sm:flex-row min-h-32">
            <!-- Tier label & menu -->
            <div class="flex items-center justify-between w-40 px-4 py-2 bg-[#ffdf80] relative">
              <span class="font-bold text-black text-xl">B Tier</span>
              <button class="settings-btn relative text-black">‚öô</button>
            </div>
            <!-- Drop area untuk item -->
            <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
            </div>
          </div>

          <div class="tier-row flex flex-col sm:flex-row min-h-32">
            <!-- Tier label & menu -->
            <div class="flex items-center justify-between w-40 px-4 py-2 bg-[#feff7f] relative">
              <span class="font-bold text-black text-xl">C Tier</span>
              <button class="settings-btn relative text-black">‚öô</button>
            </div>
            <!-- Drop area untuk item -->
            <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
            </div>
          </div>

          <div class="tier-row flex flex-col sm:flex-row min-h-32">
            <!-- Tier label & menu -->
            <div class="flex items-center justify-between w-40 px-4 py-2 bg-[#7eff80] relative">
              <span class="font-bold text-black text-xl">D Tier</span>
              <button class="settings-btn relative text-black">‚öô</button>
            </div>
            <!-- Drop area untuk item -->
            <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="tierMenu" class="absolute hidden bg-white text-sm rounded shadow w-40 z-50">
      <ul class="py-1">
        <li class="px-4 py-2 text-black hover:bg-gray-100 cursor-pointer" data-action="up">‚Üë Move Up</li>
        <li class="px-4 py-2 text-black hover:bg-gray-100 cursor-pointer" data-action="down">‚Üì Move Down</li>
        <li class="px-4 py-2 text-black hover:bg-gray-100 cursor-pointer" data-action="edit">‚úè Edit Name</li>
        <li class="px-4 py-2 text-black hover:bg-gray-100 cursor-pointer" data-action="clear">üóë Clear Row</li>
        <li class="px-4 py-2 text-red-600 hover:bg-red-100 cursor-pointer" data-action="delete">‚ùå Delete Row</li>
      </ul>
    </div>

    <div id="editTierModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-4 w-72 text-black">
        <h3 class="text-lg font-semibold mb-2">Edit Tier</h3>
        <label class="block mb-2">
          Name:
          <input id="tierNameInput" type="text" class="w-full border rounded px-2 py-1 mt-1" />
        </label>
        <div class="mb-2">
          Color:
          <div id="colorPalette" class="grid grid-cols-5 gap-3 mt-1">
            <!-- Color options inserted via JS -->
          </div>
        </div>
        <div class="flex justify-end gap-3 mt-4">
          <button id="cancelEditTier" class="px-3 py-1 bg-gray-300 rounded">Cancel</button>
          <button id="saveEditTier" class="px-3 py-1 bg-blue-600 text-white rounded">Save</button>
        </div>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="flex justify-center gap-4 my-4">
      <button class="add-btn bg-blue-600 px-4 py-2 rounded">+ Add New Tier</button>
      <button class="reset-btn bg-purple-600 px-4 py-2 rounded">Reset</button>
      <button class="save-btn bg-green-600 px-4 py-2 rounded">Save as Image</button>
    </div>

    <!-- Available Items Area -->
    <div class="w-[96%] mx-auto bg-gray-800 p-4 rounded-lg">
      <div class="flex items-center justify-between mb-2">
        <h2 id="availableTitle" class="text-lg font-semibold">Available Items (0)</h2>
        <div class="flex items-center gap-3">
          <label class="text-sm">Language:</label>
          <select id="langToggle" class="bg-gray-900 text-white rounded px-2 py-1 text-sm">
            <option value="jp">JP</option>
            <option value="id">ID</option>
          </select>
        </div>
      </div>
      <div id="availableItems" class="flex flex-wrap gap-3"></div>
    </div>

    <script type="module">
      import allMembers from "./data/members.js";
      import setlistSongs from "./data/setlistsongs.js";

      const query = new URLSearchParams(window.location.search);
      const type = query.get("type");
      const category = query.get("category");
      const generation = query.get("generation");
      const setlist = query.get("setlist");

      const setlistNameMap = {
        pajama: "Pajama Drive",
        rkj: "Aturan Anti Cinta",
        bnt: "Matahari Milikku",
        dnt: "Demi Seseorang",
        sg: "Gadis-Gadis Remaja",
        twt: "Sambil Menggandeng Erat Tanganku",
        tnm: "Dewi Theater",
        sbgn: "Bel Terakhir Berbunyi",
        sakagari: "Saka Agari",
        tadaima: "Sekarang Sedang Jatuh Cinta",
        iny: "Fajar Sang Idola",
        rsg: "Romansa Sang Gadis",
        snm: "Tunas di Balik Seragam",
        fly: "Fly, Team T!",
        rnn: "Cara Meminum Ramune",
        banzai: "Banzai",
        aitakatta: "Ingin Bertemu",
      };

      const typeTitleMap = {
        member: "Member",
        single: "Single",
        setlist: "Setlist",
      };

      let displayName;
      let availableLabel;

      if (type === "setlistSong") {
        displayName = setlistNameMap[setlist] || "Setlist Song";
        availableLabel = "Song";
      } else {
        displayName = typeTitleMap[type] || "Item";
        availableLabel = displayName;
      }

      document.getElementById("pageTitle").textContent = `My ${displayName} Tierlist`;

      function updateAvailableTitle() {
        const count = document.querySelectorAll("#availableItems > div").length;
        document.getElementById("availableTitle").textContent = `Available ${availableLabel}s (${count})`;
      }

      // Set bahasa awal dari localStorage
      let currentLang = localStorage.getItem("lang") || "jp";
      document.getElementById("langToggle").value = currentLang;

      // Update saat toggle diganti
      document.getElementById("langToggle").addEventListener("change", (e) => {
        currentLang = e.target.value;
        localStorage.setItem("lang", currentLang);
        updateItemLanguages();
      });

      document.getElementById("langToggle").addEventListener("change", (e) => {
        currentLang = e.target.value;
        updateItemLanguages();
      });

      function updateItemLanguages() {
        const allCards = document.querySelectorAll("#availableItems > div, .tier-content > div");

        allCards.forEach((card) => {
          if (type === "setlistSong") {
            const nameEl = card.querySelector("div p");
            const trackEl = card.querySelector("p.text-sm");
            const tracknumber = trackEl?.textContent;

            // Cari data aslinya
            const item = setlistSongs.find((song) => song.tracknumber === tracknumber && song.setlist === setlist);
            if (item && nameEl) {
              nameEl.textContent = currentLang === "id" ? item.idname : item.name;
            }
          }

          // Jika mendukung toggle untuk single atau setlist
          if ((type === "single" || type === "setlist") && card.querySelector("p.text-sm")) {
            const nameEl = card.querySelector("p.text-sm");
            const imgEl = card.querySelector("img");
            const src = imgEl?.getAttribute("src");
            const item = (type === "single" ? singles : setlists).find((el) => el.image === src);
            if (item && item.idname) {
              nameEl.textContent = currentLang === "id" ? item.idname : item.name;
            }
          }
        });
      }

      function renderDraggableCards(data) {
        const container = document.getElementById("availableItems");
        container.innerHTML = "";

        data.forEach((item) => {
          const div = document.createElement("div");
          if (type === "setlistSong") {
            div.className = "bg-gray-900 text-white rounded h-28 w-28 text-center cursor-move overflow-hidden flex flex-col";
            div.innerHTML = `
            <div class="text-sm flex-1 flex items-center justify-center p-1">
              <p>${currentLang === "id" ? item.idname : item.name}</p>
            </div>  
            <p class='text-sm text-white px-1 mt-1 bg-black w-full'>${item.tracknumber}</p>`;
          } else {
            div.className = "bg-transparent text-black rounded w-24 text-center cursor-move overflow-hidden";
            div.innerHTML = `
            <img src="${item.image}" class="h-24 object-cover object-top w-full mx-auto" />
            <p class='text-sm text-white px-1 mt-1 bg-black truncate w-full'>${item.name}</p>`;
          }
          container.appendChild(div);
        });

        updateAvailableTitle();
      }

      function filterAndRenderMembers() {
        let filtered = [...allMembers];

        if (category === "active") {
          filtered = filtered.filter((m) => m.isActive && !m.isTrainee);
        } else if (category === "trainee") {
          filtered = filtered.filter((m) => m.isTrainee);
        } else if (category === "ex") {
          filtered = filtered.filter((m) => !m.isActive);
        }

        // Selalu filter generasi kalau bukan "all"
        if (generation !== "all") {
          filtered = filtered.filter((m) => m.generation === generation);
        }

        // Urutkan: non-trainee dulu, lalu trainee
        filtered.sort((a, b) => {
          if (a.isTrainee === b.isTrainee) return 0;
          return a.isTrainee ? 1 : -1;
        });

        renderDraggableCards(filtered);
      }

      //drag & drop
      document.querySelectorAll(".tier-content").forEach((el) => {
        new Sortable(el, {
          group: "members",
          animation: 150,
          onAdd: function () {
            updateAvailableTitle(); // saat item ditambahkan ke tier
          },
          onRemove: function () {
            updateAvailableTitle(); // saat item dikembalikan ke available
          },
        });
      });

      new Sortable(document.getElementById("availableItems"), {
        group: "members",
        animation: 150,
        sort: true,
      });

      let activeRow = null;

      document.querySelectorAll(".settings-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const menu = document.getElementById("tierMenu");
          const rect = btn.getBoundingClientRect();

          activeRow = btn.closest(".tier-row");

          menu.style.top = `${rect.bottom + window.scrollY}px`;
          menu.style.left = `${rect.left + window.scrollX}px`;
          menu.classList.remove("hidden");
        });
      });

      // Klik luar untuk menutup menu
      document.addEventListener("click", () => {
        document.getElementById("tierMenu").classList.add("hidden");
      });

      const colorPalette = ["[#ff7f7e]", "[#ffbf7f]", "[#ffdf80]", "[#feff7f]", "[#7eff80]", "red-700", "orange-400", "yellow-400", "green-700", "blue-400", "indigo-400", "purple-400", "pink-400", "gray-400", "stone-400"];

      let selectedColor = "red";
      let editingRow = null;

      const colorContainer = document.getElementById("colorPalette");

      // Tampilkan palette warna
      colorPalette.forEach((color) => {
        const btn = document.createElement("div");
        btn.className = `w-8 h-8 rounded cursor-pointer bg-${color} border-2 border-black`;
        btn.dataset.color = color;
        btn.addEventListener("click", () => {
          selectedColor = color;

          // Hapus highlight sebelumnya
          [...colorContainer.children].forEach((el) => el.classList.remove("border-black"));
          btn.classList.add("border-black");
        });
        colorContainer.appendChild(btn);
      });

      function showTierMenu(e) {
        e.stopPropagation(); // Supaya klik menu tidak menyebar ke dokumen
        const btn = e.target;
        const menu = document.getElementById("tierMenu");
        const rect = btn.getBoundingClientRect();

        activeRow = btn.closest(".tier-row");

        menu.style.top = `${rect.bottom + window.scrollY}px`;
        menu.style.left = `${rect.left + window.scrollX}px`;
        menu.classList.remove("hidden");
      }

      // Handler edit
      document.getElementById("saveEditTier").addEventListener("click", () => {
        const nameInput = tierNameInput.value.trim();
        if (!nameInput) return;

        if (editingRow) {
          // === Edit existing tier ===
          const label = editingRow.querySelector("div.w-40");
          label.querySelector("span").textContent = nameInput;

          // Reset warna
          label.classList.forEach((cls) => {
            if (cls.startsWith("bg-")) label.classList.remove(cls);
          });
          label.classList.add(`bg-${selectedColor}`);
        } else {
          // === Add new tier ===
          const newRow = document.createElement("div");
          newRow.className = "tier-row flex";
          newRow.innerHTML = `
      <div class="flex items-center justify-between w-40 px-4 py-2 bg-${selectedColor} relative">
        <span class="font-bold text-black text-xl">${nameInput}</span>
        <button class="settings-btn relative text-black">‚öô</button>
      </div>
      <div class="flex-1 rounded-r-lg p-2 flex flex-wrap gap-3 items-center tier-content">
              <!-- Item draggable akan masuk sini -->
      </div>
    `;

          // Append ke container tier
          document.getElementById("tierListContainer").appendChild(newRow);

          // Re-bind drag & drop
          Sortable.create(newRow.querySelector(".tier-content"), {
            group: "members",
            animation: 150,
          });

          // Re-bind tombol ‚öô
          newRow.querySelector(".settings-btn").addEventListener("click", (e) => {
            activeRow = e.target.closest(".tier-row");
            showTierMenu(e);
          });
        }

        editModal.classList.add("hidden");
      });

      // Aksi menu
      document.querySelectorAll("#tierMenu li").forEach((item) => {
        item.addEventListener("click", () => {
          const action = item.dataset.action;
          if (!activeRow) return;

          switch (action) {
            case "up":
              const prev = activeRow.previousElementSibling;
              if (prev) activeRow.parentNode.insertBefore(activeRow, prev);
              break;
            case "down":
              const next = activeRow.nextElementSibling;
              if (next) activeRow.parentNode.insertBefore(next, activeRow);
              break;
            case "edit":
              editingRow = activeRow;
              const currentName = editingRow.querySelector("span").textContent;
              document.getElementById("tierNameInput").value = currentName;

              // Reset selection & modal
              selectedColor = "red";
              [...colorContainer.children].forEach((el) => el.classList.remove("border-black"));
              document.getElementById("editTierModal").classList.remove("hidden");
              break;
            case "clear":
              const dropzone = activeRow.querySelector(".tier-content");
              const available = document.getElementById("availableItems");
              // Pindahkan semua anak elemen ke available
              while (dropzone.firstChild) {
                available.appendChild(dropzone.firstChild);
              }
              updateAvailableTitle();
              break;
            case "delete":
              const tierContent = activeRow.querySelector(".tier-content");
              while (tierContent.firstChild) {
                document.getElementById("availableItems").appendChild(tierContent.firstChild);
              }
              activeRow.remove();
              updateAvailableTitle();
              break;
          }

          document.getElementById("tierMenu").classList.add("hidden");
        });
      });

      const addBtn = document.querySelector(".add-btn");
      const editModal = document.getElementById("editTierModal");
      const tierNameInput = document.getElementById("tierNameInput");

      addBtn.addEventListener("click", () => {
        editingRow = null; // <-- Penting! Supaya tahu ini add, bukan edit
        tierNameInput.value = ""; // Kosongkan input

        selectedColor = "red"; // Default
        [...colorContainer.children].forEach((el) => el.classList.remove("border-black"));
        const defaultColorBtn = [...colorContainer.children].find((el) => el.dataset.color === "red");
        if (defaultColorBtn) defaultColorBtn.classList.add("border-black");

        editModal.querySelector("h3").textContent = "Add New Tier"; // Ubah title modal
        editModal.classList.remove("hidden");
      });

      // Jalankan berdasarkan tipe
      if (type === "member") {
        filterAndRenderMembers();
      } else if (type === "setlistSong") {
        const filtered = setlistSongs.filter((song) => song.setlist === setlist);
        renderDraggableCards(filtered);
      }
    </script>
  </body>
</html>
